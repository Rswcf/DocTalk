**审核结论**
- 方向正确：以“先体验价值，再要求登录”的分层认证模型契合文档类 AI 的安全与转化诉求；将“上传文档”作为敏感动作强制登录是合理且与行业一致。
- 需要补强两点：a) 前端到后端的授权传递与路由调整；b) 游客/历史未登录文档的迁移与“归属”策略，避免安全/所有权争议。
- 技术上可行：现有 NextAuth v5、FastAPI 依赖已具备，落地成本中等；Demo 模式与配额限制也有实现路径。

**用户旅程评估**
- 分层模型合理：未登录→示例体验（额度限制）→触发关键价值点（保存/上传）→登录→持续使用（文档列表/credits）。
- 关键节点设计到位：在“上传 PDF”处要求登录，Demo 中限 5 条消息，并在恰当时机用 CTA 引导登录与保存。
- 旅程连贯性尚可，但需关注两个边界情境：
  - 双主 CTA（试用示例/上传）在首屏并列，可能分散注意力；建议根据登录态与来源动态突出主 CTA（详见建议 1）。
  - 已存在的匿名文档/会话深链如何处理与提示（详见风险与建议 6）。

**潜在 UX 问题**
- CTA 竞争与优先级不清：并列“试用示例 / 上传 PDF / 登录”可能造成决策成本上升，降低首屏点击率。
- Demo 限额透明度与期望管理：仅显示“剩余 5/5”不足以传达“登录可保存/不限量/赠送额度”等价值，易被理解为“试用版受限”，不利于转化。
- 信任与隐私信号不足：文档类产品必须在首屏/上传前明确“隐私与存储政策（不用于训练/加密/保留期）”，否则会降低上传意愿。
- 游客→登录的“会话/文档延续”预期：若 Demo 体验后登录，用户期待“把刚才的对话/进度带走”；需清晰告知可否“认领/迁移”（建议 6）。
- 本地文档列表与账号文档的概念冲突：未登录时显示“我的文档（localStorage）”与登录后的“我的文档（账户）”易混淆，需要更清晰的文案与迁移策略。
- 移动端与可访问性：拖拽上传为桌面心智，移动端需突出“从文件/云盘选择”；ARIA/键盘导航/高对比度需覆盖。

**技术可行性检查**
- 身份与会话
  - 已集成 NextAuth v5 + Google Provider，且具备自定义 Adapter 对 FastAPI 的用户/账户/验证令牌读写支持，满足 SSO/Email Provider 扩展需求（frontend/src/lib/auth.ts:1, frontend/src/lib/authAdapter.ts:1, backend/app/api/auth.py:1）。
  - Next.js 代理路由会在请求头注入 Authorization（frontend/src/app/api/proxy/[...path]/route.ts:1）。但当前前端 API 直接打到后端，不带授权头（frontend/src/lib/api.ts:1）。这与“上传需登录”的目标冲突。
- 后端授权与资源访问
  - 后端已提供“可选用户”与“强制用户”的依赖（backend/app/core/deps.py:1）。文档上传当前使用 get_current_user_optional，应切换为 require_auth 强制登录（backend/app/api/documents.py:16）。
  - 文档访问控制已考虑“若文档有 owner 则校验 user_id；否则匿名可读”（backend/app/api/documents.py:65,80,96），与“历史匿名文档”兼容。
- 文档列表与存储
  - 目前首页使用 localStorage 维护“我的文档”，并非服务端列表（frontend/src/app/page.tsx:1）。计划中的“按 user_id 列表”后端接口尚未实现，需新增（建议统一放到 documents_router 下，如 GET /api/documents?mine=1）。
- Demo 模式与限额
  - 计划提到 demo_sessions 表，但当前模型中无该表。可以先以“固定 sample 文档 ID + 会话 is_demo 标记”替代，或先用前端限额+轻量 cookie 做 MVP，再在服务端落地“会话/用户或匿名指纹”的日限控（credits/usage 体系已存在，可复用策略）。
- 迁移与兼容
  - “登录后自动关联 localStorage 文档”目前无可信证明链（历史匿名文档缺少 claim token）。直接“认领”存在安全风险（他人可据 ID 夺取）。应调整迁移策略（见建议 6）。

**Best Practice 研究要点（基于 2024–2025 行业趋势与已知模式）**
- 登录/注册趋势
  - 密码less 优先：Google/Microsoft/Apple SSO + Email Magic Link +（可选）Passkey，减少摩擦，提高移动端完成率。
  - JIT Auth（Just-in-time）：在用户触发关键价值（上传/保存/导出/多设备）的瞬间弹出登录，不把登录放在首步。
  - 单一强主 CTA：首屏只突出一条流，其他作为次级入口，降低选择成本。
- Progressive Disclosure（循序展示）
  - 先展示最小可感知价值（无门槛示例体验）；在必要动作再请求信息/权限；高级选项晚些露出（如模型切换、批量导入、团队空间）。
- Value-first Onboarding（价值优先）
  - 提供真实、可互动的样例内容；一屏给到“能做什么+一键操作”；在完成第一次 aha moment 后再讲账户/付费。
  - 强化社会证明与信任：简明隐私承诺、数据不训练、企业级安全徽章、典型使用场景。
- 新兴工具观察（概括性归纳）
  - Lovable/Bolt/v0 等面向开发者/创作者的 AI 工具普遍采用 SSO 做首选按钮；在“创建/生成”动作时再弹出登录；提供项目模板/示例以降低首次空白焦虑；开发者向产品偏好 GitHub/GitLab/Google 登录优先序；在表单字段上做 Progressive Disclosure（例如先选模板，再补充细项）。
- 文档 AI 特有要点
  - 上传即敏感：安全与隐私承诺必须前置，一键可见（不训练/加密/保留期/可随时删除）。
  - 页码级引用与高亮是核心 aha moment：示例必须精准展示这两个能力，且允许用户“点链接跳页、框选高亮、复制引用”。

**具体改进建议（≥5）**
1) 动态主 CTA 策略（强主 + 次级）
- 做法：未登录用户首屏只突出“试用示例（立即体验）”，“上传 PDF（登录）”降级为次级按钮或合并到上传区提示；登录用户首屏强主 CTA 改为“上传 PDF”（示例降级为次级）。
- 原因：降低决策成本、突出当前最合理路径（游客→体验；已登录→生产力）。
- 预期效果：提升首屏 CTR 与首轮互动率，减少“犹豫时间”。

2) JIT 登录模态而非跳转页
- 做法：点击“上传”或 Demo 内“保存对话/继续使用”时，使用模态触发 `signIn('google')`；保留 `/auth` 路由作为降级与 SEO；模态内补充隐私承诺与“登录即送 X 额度”。
- 原因：减少上下文切换，降低流失。
- 预期效果：登录完成率提升，转化更顺滑。

3) 示例库分行业&任务，并突出“引用+高亮”能力
- 做法：提供 3–4 个精选示例（科研论文、财报/10-K、合同、说明书），每个示例预置 2–3 个引导问题，回答展示页码级引用与高亮框。
- 原因：文档 AI 的价值需要在真实上下文中被看见；多样场景更易触达不同人群。
- 预期效果：Demo 停留时长↑、登录转化↑、用户对“精准引用”的认知更强。

4) 信任与隐私微文案前置 + 可视化“安全卡片”
- 做法：上传区上方放一行“我们不使用你的文档训练模型；加密存储；可随时删除”；点击可展开“安全卡片”（保留期/加密/地域/合规）。
- 原因：降低对上传敏感文件的心理阻力。
- 预期效果：上传率↑、跳出率↓，尤其对企业/法律/医疗用户。

5) 游客→登录的会话延续策略（显式规则 + 提示）
- 做法：在 Demo 页顶部提示“登录后可保存当前对话与标注”；登录完成后将 Demo 会话“复制为新会话并归属账号”，避免直接“认领”匿名资源；保留“示例只读”不被误认为自己的文档。
- 原因：兼顾体验连续性与安全边界，避免匿名文档“被认领”争议。
- 预期效果：减少困惑与投诉，保证可预期的行为。

6) 历史本地文档迁移：安全替代方案
- 做法：废弃“自动关联 localStorage 文档”；提供“导入历史文件记录”引导：用户可“一键重新上传最近文档”（列表中显示历史文件名与时间，仅做快捷入口），并解释原因（安全合规）。
- 原因：历史匿名文档缺少可信 claim token，强行“认领”有安全风险。
- 预期效果：规避安全隐患，保证体验与策略一致。

7) 前端 API 改为统一走代理并注入授权
- 做法：将 `frontend/src/lib/api.ts` 里所有 `API_BASE` 请求改用 `/api/proxy`，由路由自动附加 `Authorization`（frontend/src/app/api/proxy/[...path]/route.ts:1）；上传、删除、会话等敏感接口都走代理。
- 原因：确保服务端能识别登录态，真正实现“上传需登录”等策略。
- 预期效果：后端授权逻辑生效，减少 CORS/跨源 Cookie 问题。

8) 新增“我的文档（服务端）”列表与空状态指引
- 做法：实现 GET `/api/documents?mine=1`；登录首页“我的文档”展示服务端列表；未登录则显示“示例入口 + 登录提示”空状态。
- 原因：与账号体系一致，支持多设备/持久化。
- 预期效果：留存↑，多设备使用体验↑。

9) 激励文案与额度显性化
- 做法：在 CTA 附近展示“登录即送 50 credits / 每日免费 20 条”等；Demo 内显示“剩余次数 + 登录解锁更多/保存”。
- 原因：明确价值交换，降低对登录的排斥。
- 预期效果：登录转化↑、付费漏斗前段更健康。

10) 渐进式参数与高级功能的延后暴露
- 做法：模型选择、温度、引用样式导出等高级选项默认折叠；首次达成 aha moment 后再引导探索。
- 原因：降低初学者负担，避免干扰核心任务。
- 预期效果：首轮成功率↑，学习曲线更平滑。

**实现可行性与差距清单**
- 后端上传强制登录：将 `upload_document` 的依赖改为 `require_auth`，并在前端改为走 `/api/proxy`（backend/app/api/documents.py:16, frontend/src/lib/api.ts:1）。
- 文档列表 API：新增 GET `/api/documents?mine=1`（按 user_id 过滤，返回分页/简要元信息）。
- Demo 会话限额：MVP 先前端限制 + 轻量 cookie；服务端落地可在 sessions 表加 `is_demo` 字段或在 chat 入口对 sample 文档 ID 特判与配额核验（后续可融合到 credits/usage）。
- Email Magic Link：NextAuth v5 + 现有 Adapter 已具备 Verification Token 支持（frontend/src/lib/authAdapter.ts:117, backend/app/api/auth.py:107），落地需邮件服务与模板。
- 迁移策略：提供“重新上传历史文档”引导与说明，不做“自动关联”。

**风险评估**
- 强制登录对流失的影响
  - 预估：在“上传”环节设门槛通常带来 15–35% 首次操作流失；但若结合优质 Demo + 明确激励（赠送 credits + 保存/多设备），净转化可回补并提升付费质量。
  - 缓解：JIT 登录、模态不跳转、激励清晰、隐私承诺前置。
- 实现复杂度
  - 低-中：后端上传授权、代理路由切换、首页 UI 重构、示例页（不含服务端配额）。
  - 中：服务端文档列表、Email Magic Link（含邮件）、分析埋点与 A/B。
  - 中-高：服务端配额/日限（含匿名识别策略）、Passkey、团队/企业登录（Azure AD）。
- 优先级排序（P0→P2）
  - P0（立即）：后端上传 require_auth；前端改走 `/api/proxy`；首页 CTA 调整 + 隐私微文案；示例页（前端限额）。
  - P1：服务端“我的文档”与空状态；Email Magic Link；登录模态；精选示例库与引导问题；埋点与关键事件（点击、登录、上传、保存）。
  - P2：服务端配额/日限与 is_demo 标记；企业 SSO（Microsoft）；Passkey；导出/引用样式等高级功能的渐进式曝光。

**对计划文档的具体指正（差距/更正）**
- 前端授权传递缺口：当前 `api.ts` 未走代理，不会注入 Authorization，需更新（frontend/src/lib/api.ts:1 对比 frontend/src/app/api/proxy/[...path]/route.ts:1）。
- “自动关联 localStorage 文档”风险高：建议改为“重新上传快捷入口”，并在计划中明确放弃自动归属策略。
- 文档列表 API 路径与路由归属：优先放在 `documents_router` 下（如 GET /api/documents?mine=1），避免新建 `documents_list.py` 分散资源命名。
- Demo 落地建议先行“前端限额 + 明确文案”，服务端限额放到下一阶段与 credits/usage 统一。
- 双主 CTA 需动态策略：建议在计划中加入“按场景/登录态动态主 CTA”的准则与埋点验证。

**下一步建议**
- 我可以：补充改动清单与任务拆解（前端 API 代理切换、后端授权依赖调整、Demo 首屏与引导、文档列表 API 形态、埋点方案），并提交更新版计划（v1.1）。是否需要我起草任务清单与验收标准？